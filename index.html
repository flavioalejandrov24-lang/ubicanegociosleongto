<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ubicanegoleon - Directorio de Negocios en León, Gto.</title>
    <meta name="theme-color" content="#d4af37">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 50%, #e8e8e8 100%); min-height: 100vh; color: #1a1a1a; }
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); border: 1px solid rgba(212, 175, 55, 0.15); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12); border-radius: 24px; }
        .glass-light { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(212, 175, 55, 0.1); border-radius: 20px; }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .card-hover { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-12px) scale(1.02); box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2); }
        .gradient-gold { background: linear-gradient(135deg, #d4af37 0%, #f4d03f 50%, #d4af37 100%); }
        .gradient-gold-white { background: linear-gradient(135deg, #d4af37 0%, #ffffff 100%); }
        .gradient-green-strong { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); }
        .gradient-black-white-bg { background: linear-gradient(135deg, #ffffff 0%, #4a4a4a 50%, #ffffff 100%); }
        .gradient-green-intense { background: linear-gradient(135deg, rgba(22, 163, 74, 0.98) 0%, rgba(21, 128, 61, 0.98) 100%); }
        .gradient-green { background: linear-gradient(135deg, rgba(34, 197, 94, 0.95) 0%, rgba(22, 163, 74, 0.95) 100%); }
        .gradient-green-translucent { background: linear-gradient(135deg, rgba(34, 197, 94, 0.7) 0%, rgba(22, 163, 74, 0.7) 100%); }
        .gradient-blue-strong { background: linear-gradient(135deg, rgba(30, 64, 175, 0.95) 0%, rgba(37, 99, 235, 0.95) 100%); }
        .gradient-navy-blue { background: linear-gradient(135deg, rgba(30, 58, 138, 0.95) 0%, rgba(30, 64, 175, 0.95) 50%, rgba(59, 130, 246, 0.95) 100%); }
        .gradient-red { background: linear-gradient(135deg, rgba(220, 38, 38, 0.95) 0%, rgba(185, 28, 28, 0.95) 100%); }
        .gradient-yellow-white-soft { background: linear-gradient(135deg, #fef9e7 0%, #fffbf0 50%, #ffffff 100%); }
        .gradient-gold-text { background: linear-gradient(135deg, #d4af37 0%, #1a1a1a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .gradient-gold-text-animated { background: linear-gradient(135deg, #d4af37 0%, #f4d03f 50%, #d4af37 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: shine-text 3s infinite; background-size: 200% 200%; }
        @keyframes shine-text { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .input-focus { transition: all 0.3s ease; }
        .input-focus:focus { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(212, 175, 55, 0.25); border-color: #d4af37; }
        .btn-gold { background: linear-gradient(135deg, #d4af37 0%, #ffffff 100%); color: #000000; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); }
        .btn-gold:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4); background: linear-gradient(135deg, #ffffff 0%, #d4af37 100%); }
        .pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .modal-overlay { background: rgba(0, 0, 0, 0.65); backdrop-filter: blur(10px); }
        .modal-content { animation: modalSlide 0.4s ease-out; }
        @keyframes modalSlide { from { opacity: 0; transform: scale(0.9) translateY(-30px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .image-upload-container { cursor: pointer; transition: all 0.3s ease; border-radius: 20px; }
        .image-upload-container:hover { transform: scale(1.03); border-color: rgba(212, 175, 55, 0.6); }
        .image-preview-logo { width: 100%; height: 100%; object-fit: cover; border-radius: 18px; }
        .user-initial-circle { background: rgba(255, 255, 255, 0.95); color: #d4af37; border: 2px solid #d4af37; }
        .forgot-password-link { color: #1a1a1a; font-weight: 600; }
        .forgot-password-link:hover { color: #d4af37; }
        .register-link { color: #2563eb; }
        .register-link:hover { color: #1d4ed8; text-decoration: underline; }
        .icon-location { color: rgba(59, 130, 246, 0.95); }
        .icon-phone { color: rgba(34, 197, 94, 0.95); }
        .rating-badge { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); border-radius: 20px; padding: 8px 16px; }
        .business-card-footer { background: linear-gradient(to bottom, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 1)); box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.08); border-radius: 0 0 24px 24px; }
        .header-gold { background: linear-gradient(135deg, #d4af37 0%, #ffffff 100%); }
        .header-text-white { color: white; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5), 0 0 10px rgba(212, 175, 55, 0.8); }
        .header-icon-gold { color: #d4af37; filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.3)); }
        .header-icon-black { color: #000000; }
        .back-button { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.4); transition: all 0.3s ease; border-radius: 16px; }
        .back-button:hover { background: rgba(255, 255, 255, 0.4); transform: scale(1.05); }
        .profile-header-container { background: linear-gradient(135deg, #d4af37 0%, #f4d03f 50%, #d4af37 100%); box-shadow: 0 10px 40px rgba(212, 175, 55, 0.3); position: relative; }
        .rating-container-profile { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(15px); border-radius: 24px; padding: 20px; box-shadow: 0 8px 30px rgba(212, 175, 55, 0.5); }
        .section-card-gold-border { background: rgba(255, 255, 255, 0.98); border: 3px solid #d4af37; box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3); border-radius: 20px; }
        .info-container-white { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 24px; padding: 32px; box-shadow: 0 8px 30px rgba(212, 175, 55, 0.2); }
        .form-label-icon { display: inline-flex; align-items: center; gap: 12px; }
        .form-label-icon i { min-width: 20px; }
        .business-name-white { color: white; font-weight: 800; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); }
        .delete-account-gold { color: #d4af37 !important; font-weight: 700; }
        .title-gold-dark { color: #b8941e; font-weight: 700; }
        .card-text-bold { font-weight: 700; }
        .map-container { width: 100%; height: 350px; border-radius: 20px; overflow: hidden; margin-top: 16px; border: 3px solid #d4af37; }
        .text-red-strong { color: #dc2626; font-weight: 700; }
        .whatsapp-button { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); }
        .whatsapp-button:hover { background: linear-gradient(135deg, #15803d 0%, #166534 100%); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(34, 197, 94, 0.4); }
        .shine { position: relative; overflow: hidden; }
        .shine::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent); animation: shine 3s infinite; z-index: 1; }
        @keyframes shine { 0% { left: -100%; } 50%, 100% { left: 100%; } }
        .business-card-name { background: linear-gradient(135deg, #d4af37 0%, #1a1a1a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 800; }
        .uppercase-force { text-transform: uppercase; }
        .category-badge-white-gold { background: white; color: #d4af37; font-weight: 700; border: 2px solid #d4af37; }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="modal-root"></div>
    <script>
        const SUPABASE_URL = 'https://igastcafgjwijvgvcclr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnYXN0Y2FmZ2p3aWp2Z3ZjY2xyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODkzMjMsImV4cCI6MjA4NDE2NTMyM30.GQxFvm76xHzKj3px7HBtehi5EOOpSQvqk26DAkt2Tz4';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {auth: { autoRefreshToken: true, persistSession: true, detectSessionInUrl: true, storage: window.localStorage, storageKey: 'ubicanegoleon-v4' }});
        let state = {view: 'login', user: null, businesses: [], currentBusiness: null, searchTerm: '', tempSearchTerm: '', viewCount: 1800, keepLoggedIn: false, selectedRating: 0, showPassword: {}, isPasswordReset: false, lastAuthError: null, authAttempts: 0, enableHours: false, showCustomDays: false, formData: { name: '', representative: '', category: '', street: '', colony: '', phone: '', hours: 'No definido', days: 'No definido', custom_days: '', description: '', services: '', logo: null, logo_url: '', agreed: false, latitude: 21.1212, longitude: -101.6869 }};
        function showModal(t,m,type='error'){const icons={error:{icon:'fa-exclamation-circle',color:'text-red-500',bg:'bg-red-500/10'},success:{icon:'fa-check-circle',color:'text-green-500',bg:'bg-green-500/10'},info:{icon:'fa-info-circle',color:'text-blue-500',bg:'bg-blue-500/10'},warning:{icon:'fa-exclamation-triangle',color:'text-yellow-500',bg:'bg-yellow-500/10'}};const s=icons[type]||icons.info;const modal=document.createElement('div');modal.className='modal-overlay fixed inset-0 z-50 flex items-center justify-center p-6';modal.innerHTML=`<div class="modal-content glass max-w-md w-full overflow-hidden shadow-2xl border-2 border-${type==='error'?'red':type==='success'?'green':'blue'}-500/30"><div class="${s.bg} p-6 border-b border-gray-300/50"><div class="flex items-center gap-4"><div class="w-16 h-16 rounded-full bg-white/50 flex items-center justify-center shadow-lg"><i class="fas ${s.icon} text-4xl ${s.color}"></i></div><h3 class="text-2xl font-bold text-gray-900">${t}</h3></div></div><div class="p-6"><p class="text-gray-700 leading-relaxed text-lg">${m}</p></div><div class="p-6 pt-0 flex gap-3"><button onclick="this.closest('.modal-overlay').remove()" class="flex-1 px-6 py-4 gradient-red text-white rounded-xl font-semibold transition-all hover:shadow-lg hover:scale-105">Cerrar</button></div></div>`;document.getElementById('modal-root').appendChild(modal);setTimeout(()=>modal.remove(),6000);}
        function showPasswordResetModal(){const modal=document.createElement('div');modal.className='modal-overlay fixed inset-0 z-50 flex items-center justify-center p-6';modal.innerHTML=`<div class="modal-content glass max-w-md w-full overflow-hidden shadow-2xl border-2 border-blue-500/30"><div class="bg-blue-500/10 p-6 border-b border-gray-300/50"><div class="flex items-center gap-4"><div class="w-16 h-16 rounded-full bg-white/50 flex items-center justify-center shadow-lg"><i class="fas fa-key text-4xl text-blue-500"></i></div><h3 class="text-2xl font-bold text-gray-900">Nueva Contraseña</h3></div></div><form id="password-reset-form" class="p-6 space-y-5"><p class="text-gray-600 mb-4 text-base">Establece tu nueva contraseña.</p><div><label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-lock text-yellow-600 mr-2"></i>Nueva Contraseña</label><div class="relative"><input type="password" id="new-password-reset" required placeholder="Mínimo 6 caracteres" class="w-full px-5 py-4 pr-12 rounded-xl border-2 border-gray-300 bg-white text-gray-900 focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus transition-all"><button type="button" onclick="togglePasswordInModal('new-password-reset')" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-600 hover:text-yellow-600 transition-colors"><i class="fas fa-eye" id="icon-new-password-reset"></i></button></div></div><div><label class="block text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-lock text-yellow-600 mr-2"></i>Confirmar Contraseña</label><div class="relative"><input type="password" id="confirm-new-password-reset" required placeholder="Repite la contraseña" class="w-full px-5 py-4 pr-12 rounded-xl border-2 border-gray-300 bg-white text-gray-900 focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus transition-all"><button type="button" onclick="togglePasswordInModal('confirm-new-password-reset')" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-600 hover:text-yellow-600 transition-colors"><i class="fas fa-eye" id="icon-confirm-new-password-reset"></i></button></div></div><div class="flex gap-3 pt-4"><button type="button" onclick="this.closest('.modal-overlay').remove(); logoutUser();" class="flex-1 px-6 py-4 gradient-red text-white rounded-xl font-semibold transition-all hover:shadow-lg hover:scale-105">Cancelar</button><button type="submit" class="flex-1 px-6 py-4 gradient-green text-white rounded-xl font-semibold transition-all hover:shadow-lg hover:scale-105">Cambiar</button></div></form></div>`;document.getElementById('modal-root').appendChild(modal);document.getElementById('password-reset-form').addEventListener('submit',async(e)=>{e.preventDefault();const n=document.getElementById('new-password-reset').value;const c=document.getElementById('confirm-new-password-reset').value;if(n!==c){showModal('Error','Las contraseñas no coinciden','error');return;}if(n.length<6){showModal('Error','Mínimo 6 caracteres','error');return;}try{const{error}=await supabaseClient.auth.updateUser({password:n});if(error)throw error;modal.remove();window.history.replaceState(null,'',window.location.pathname);showModal('¡Éxito!','Contraseña actualizada.','success');state.isPasswordReset=false;setTimeout(()=>logoutUser(),2000);}catch(error){showModal('Error',error.message,'error');}});}
        function showDeleteAccountModal(){const modal=document.createElement('div');modal.className='modal-overlay fixed inset-0 z-50 flex items-center justify-center p-6';modal.innerHTML=`<div class="modal-content glass max-w-md w-full overflow-hidden shadow-2xl border-2 border-red-500/30"><div class="bg-red-500/10 p-6 border-b border-gray-300/50"><div class="flex items-center gap-4"><div class="w-16 h-16 rounded-full bg-white/50 flex items-center justify-center shadow-lg"><i class="fas fa-exclamation-triangle text-4xl text-red-500"></i></div><h3 class="text-2xl font-bold text-gray-900">Eliminar Cuenta</h3></div></div><div class="p-6 space-y-4"><p class="text-gray-700 leading-relaxed text-lg font-semibold">⚠️ Acción permanente.</p><p class="text-gray-600">Se eliminará:</p><ul class="list-disc list-inside text-gray-600 space-y-2 ml-4"><li>Tu cuenta</li><li>Todos tus negocios</li><li>Todas tus reseñas</li></ul><div class="bg-yellow-500/10 border-2 border-yellow-500/30 rounded-xl p-4 mt-4"><p class="text-yellow-700 font-semibold text-sm"><i class="fas fa-info-circle mr-2"></i>Escribe "ELIMINAR"</p></div><input type="text" id="delete-confirmation-input" placeholder="Escribe ELIMINAR" class="w-full px-5 py-4 rounded-xl border-2 border-gray-300 bg-white text-gray-900 focus:border-red-500 focus:ring-4 focus:ring-red-500/20 outline-none input-focus transition-all"></div><div class="p-6 pt-0 flex gap-3"><button onclick="this.closest('.modal-overlay').remove()" class="flex-1 px-6 py-4 bg-gray-300 hover:bg-gray-400 text-gray-900 rounded-xl font-semibold transition-all hover:scale-105">Cancelar</button><button onclick="confirmDeleteAccount()" class="flex-1 px-6 py-4 gradient-red text-white rounded-xl font-semibold transition-all hover:scale-105 hover:shadow-lg"><i class="fas fa-trash mr-2"></i>Eliminar</button></div></div>`;document.getElementById('modal-root').appendChild(modal);}
        async function confirmDeleteAccount(){const i=document.getElementById('delete-confirmation-input');if(!i||i.value.toUpperCase()!=='ELIMINAR'){showModal('Confirmación Requerida','Escribe "ELIMINAR"','warning');return;}try{const u=state.user.id;await supabaseClient.from('reviews').delete().eq('user_id',u);await supabaseClient.from('businesses').delete().eq('user_id',u);await supabaseClient.auth.signOut();document.querySelector('.modal-overlay')?.remove();showModal('Cuenta Eliminada','Cuenta eliminada.','success');state.user=null;state.view='login';localStorage.clear();sessionStorage.clear();setTimeout(()=>render(),2000);}catch(error){showModal('Error','No se pudo eliminar.','error');}}
        function togglePasswordInModal(inputId){const input=document.getElementById(inputId);const icon=document.getElementById(`icon-${inputId}`);if(input&&icon){if(input.type==='password'){input.type='text';icon.className='fas fa-eye-slash';}else{input.type='password';icon.className='fas fa-eye';}}}
        function getAuthErrorMessage(error){const msg=error.message||'';if(msg.includes('User already registered')||msg.includes('already been registered'))return{title:'Usuario Existente',message:'Este correo ya está registrado.',type:'warning'};if(msg.includes('Invalid login credentials'))return{title:'Credenciales Incorrectas',message:'Correo o contraseña incorrectos.',type:'error'};if(msg.includes('Email not confirmed'))return{title:'Correo No Confirmado',message:'Confirma tu correo primero.',type:'info'};if(msg.includes('invalid format'))return{title:'Formato Inválido',message:'Formato del correo inválido.',type:'error'};if(msg.includes('Password should be at least 6'))return{title:'Contraseña Débil',message:'Mínimo 6 caracteres.',type:'error'};if(msg.includes('rate limit'))return{title:'Demasiados Intentos',message:'Espera unos minutos.',type:'warning'};return{title:'Error',message:msg||'Error inesperado.',type:'error'};}
        function isValidEmail(email){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);}
        async function loginUser(email,password){try{state.lastAuthError=null;const{data,error}=await supabaseClient.auth.signInWithPassword({email:email.toLowerCase().trim(),password});if(error){state.lastAuthError=error;state.authAttempts++;throw error;}state.user=data.user;state.authAttempts=0;return{success:true};}catch(error){return{success:false,error};}}
        async function registerUser(email,password,confirmPassword){try{state.lastAuthError=null;if(!isValidEmail(email))throw new Error('invalid format');if(password.length<6)throw new Error('Password should be at least 6 characters');if(password!==confirmPassword)throw new Error('Las contraseñas no coinciden');const{data,error}=await supabaseClient.auth.signUp({email:email.toLowerCase().trim(),password,options:{emailRedirectTo:`${window.location.origin}${window.location.pathname}`}});if(error){state.lastAuthError=error;throw error;}if(data.user&&data.user.identities&&data.user.identities.length===0)throw new Error('User already registered');return{success:true,requiresConfirmation:!data.session};}catch(error){return{success:false,error};}}
        async function logoutUser(){try{await supabaseClient.auth.signOut();}catch(e){}state.user=null;state.view='login';state.isPasswordReset=false;state.lastAuthError=null;state.authAttempts=0;localStorage.clear();sessionStorage.clear();window.history.replaceState(null,'',window.location.pathname);render();}
        async function resetPassword(email){try{if(!isValidEmail(email))throw new Error('invalid format');const{error}=await supabaseClient.auth.resetPasswordForEmail(email.toLowerCase().trim(),{redirectTo:`${window.location.origin}${window.location.pathname}`});if(error)throw error;return{success:true};}catch(error){return{success:false,error};}}
        async function loadBusinesses(){try{const{data,error}=await supabaseClient.from('businesses').select(`*, reviews(id, rating, comment, user_name, created_at)`).order('created_at',{ascending:false});if(error)throw error;state.businesses=(data||[]).map(b=>{const reviews=b.reviews||[];const avgRating=reviews.length>0?(reviews.reduce((sum,r)=>sum+r.rating,0)/reviews.length).toFixed(1):0;return{...b,rating:avgRating,total_ratings:reviews.length};});}catch(error){state.businesses=[];}}
        async function saveBusiness(formData){if(!formData.name||formData.name.trim()===''){showModal('Obligatorio','NOMBRE es obligatorio.','warning');return false;}if(!formData.street||formData.street.trim()===''){showModal('Obligatorio','CALLE Y NÚMERO son obligatorios.','warning');return false;}if(!formData.colony||formData.colony.trim()===''){showModal('Obligatorio','COLONIA es obligatoria.','warning');return false;}if(!formData.phone||formData.phone.trim()===''){showModal('Obligatorio','TELÉFONO es obligatorio.','warning');return false;}const phoneDigits=formData.phone.replace(/\D/g,'');if(phoneDigits.length!==10){showModal('Teléfono Inválido','Debe tener 10 dígitos.','error');return false;}if(!formData.agreed){showModal('Confirmación','Confirma los datos.','warning');return false;}try{const logoUrl=formData.logo_url||null;const fullAddress=`${formData.street.trim()}, ${formData.colony.trim()}`;const businessData={name:formData.name.trim().toUpperCase(),representative:formData.representative.trim()||null,category:formData.category.trim()||null,address:fullAddress,phone:phoneDigits,hours:formData.hours&&formData.hours.trim()!==''?formData.hours.trim():'No definido',days:formData.days||'No definido',custom_days:formData.days==='Otro'?(formData.custom_days.trim()||null):null,description:formData.description.trim()||null,services:formData.services.trim()||null,logo_url:logoUrl,city:'León, Guanajuato',user_id:state.user.id,latitude:formData.latitude||21.1212,longitude:formData.longitude||-101.6869};let saveResult;if(state.currentBusiness){saveResult=await supabaseClient.from('businesses').update(businessData).eq('id',state.currentBusiness.id).select();}else{saveResult=await supabaseClient.from('businesses').insert([businessData]).select();}if(saveResult.error)throw saveResult.error;showModal('¡Éxito!',state.currentBusiness?'Actualizado':'Registrado','success');await loadBusinesses();state.view='list';state.currentBusiness=null;resetForm();render();return true;}catch(error){showModal('Error','Error: '+(error.message||'Desconocido'),'error');return false;}}
        async function deleteBusiness(id){if(!confirm('¿Eliminar?'))return;try{const{error}=await supabaseClient.from('businesses').delete().eq('id',id);if(error)throw error;await loadBusinesses();state.view='list';showModal('Eliminado','Negocio eliminado.','success');render();}catch(error){showModal('Error',error.message,'error');}}
        async function saveReview(businessId,rating,comment){if(!state.user){showModal('Sesión Requerida','Inicia sesión.','warning');return false;}if(!rating||rating===0){showModal('Calificación Requerida','Selecciona 1-5 estrellas.','warning');return false;}try{const reviewData={business_id:businessId,user_id:state.user.id,user_name:state.user.email.split('@')[0],rating:parseInt(rating),comment:comment.trim()};const{data,error}=await supabaseClient.from('reviews').insert([reviewData]).select();if(error)throw error;await loadBusinesses();state.selectedRating=0;showModal('¡Gracias!','Reseña publicada.','success');setTimeout(()=>{const business=state.businesses.find(b=>b.id===businessId);if(business){state.currentBusiness=business;render();}},500);return true;}catch(error){showModal('Error','No se pudo guardar: '+(error.message||'Error desconocido'),'error');return false;}}
        function resetForm(){state.formData={name:'',representative:'',category:'',street:'',colony:'',phone:'',hours:'No definido',days:'No definido',custom_days:'',description:'',services:'',logo:null,logo_url:'',agreed:false,latitude:21.1212,longitude:-101.6869};state.enableHours=false;state.showCustomDays=false;}
        function togglePassword(id){state.showPassword[id]=!state.showPassword[id];const input=document.getElementById(id);if(input)input.type=state.showPassword[id]?'text':'password';const button=input?.nextElementSibling?.querySelector('i');if(button)button.className=`fas fa-eye${state.showPassword[id]?'-slash':''}`;}
        function toggleHoursInput(){state.enableHours=!state.enableHours;const h=document.getElementById('hours');if(h){h.disabled=!state.enableHours;if(state.enableHours){h.value='';h.placeholder='Ej: 7:00 AM - 9:00 PM';state.formData.hours='';}else{h.value='No definido';h.placeholder='No definido';state.formData.hours='No definido';}}}
        function handleDaysChange(value){state.formData.days=value;state.showCustomDays=value==='Otro';render();}
        function forceUppercase(event){const input=event.target;const start=input.selectionStart;const end=input.selectionEnd;input.value=input.value.toUpperCase();input.setSelectionRange(start,end);}
        function openWhatsApp(phone,businessName){const phoneClean=phone.replace(/\D/g,'');const whatsappNumber='52'+phoneClean;const message=`Hola, vi tu negocio "${businessName}" en UbicaNegoLeon y me gustaría más información.`;window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`,'_blank');}
        function initMap(lat,lng,businessName,address){const m=document.getElementById('business-map');if(!m)return;const q=encodeURIComponent(`${businessName}, ${address||'León, Guanajuato, México'}`);const iframe=document.createElement('iframe');iframe.width='100%';iframe.height='100%';iframe.style.border='0';iframe.loading='lazy';iframe.allowFullscreen=true;iframe.referrerPolicy='no-referrer-when-downgrade';iframe.src=`https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${q}&zoom=15`;m.innerHTML='';m.appendChild(iframe);}
        setInterval(()=>{state.viewCount+=Math.floor(Math.random()*5)+1;const el=document.getElementById('view-counter');if(el)el.textContent=state.viewCount.toLocaleString();},600000);
        const Header=()=>`<header class="header-gold sticky top-0 z-40 shadow-xl"><div class="max-w-7xl mx-auto px-4 sm:px-6 py-4"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div><h1 class="text-xl sm:text-2xl font-bold header-text-white">Ubicanegoleon</h1><p class="text-xs header-text-white">León, Guanajuato</p></div></div><nav class="flex items-center gap-2 sm:gap-3">${state.view!=='login'&&state.view!=='register'?`<button onclick="changeView('list')" class="p-2 sm:p-3 rounded-xl transition-all ${state.view==='list'?'bg-white/40 header-icon-gold':'header-icon-black hover:bg-white/20'}"><i class="fas fa-home text-base sm:text-lg"></i></button>`:''}${state.user?`<button onclick="createBusiness()" class="gradient-green text-white px-3 sm:px-5 py-2 sm:py-3 rounded-xl font-semibold shadow-lg hidden md:flex items-center gap-2 hover:scale-105 transition-all"><i class="fas fa-plus"></i><span>Registrar</span></button><button onclick="createBusiness()" class="gradient-green text-white p-2 sm:p-3 rounded-xl shadow-lg md:hidden hover:scale-105 transition-all"><i class="fas fa-plus"></i></button><div class="relative group"><button class="flex items-center gap-2 px-3 sm:px-4 py-2 rounded-xl hover:bg-white/20 transition-all"><div class="w-7 h-7 sm:w-8 sm:h-8 user-initial-circle rounded-full flex items-center justify-center font-bold text-xs sm:text-sm shadow-lg">${state.user.email.charAt(0).toUpperCase()}</div><i class="fas fa-chevron-down text-xs text-gray-700 hidden sm:block"></i></button><div class="absolute right-0 mt-2 w-56 glass shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all"><div class="p-4 border-b border-gray-300"><p class="text-sm font-semibold text-gray-900 truncate">${state.user.email}</p><p class="text-xs text-gray-600 mt-1">Usuario registrado</p></div><button onclick="showDeleteAccountModal()" class="w-full px-4 py-3 text-left delete-account-gold hover:bg-orange-500/10 transition-all flex items-center gap-3 border-b border-gray-300"><i class="fas fa-user-times"></i><span class="font-medium">Eliminar cuenta</span></button><button onclick="logoutUser()" class="w-full px-4 py-3 text-left text-red-600 hover:bg-red-500/10 rounded-b-2xl transition-all flex items-center gap-3"><i class="fas fa-sign-out-alt"></i><span class="font-medium">Cerrar sesión</span></button></div></div>`:`${state.view!=='login'&&state.view!=='register'?`<button onclick="changeView('login')" class="px-3 sm:px-5 py-2 sm:py-2.5 text-gray-900 hover:bg-white/20 rounded-xl font-semibold transition-all text-sm sm:text-base">Iniciar Sesión</button>`:''}`}</nav></div></div></header>`;
        const Footer=()=>`<div class="fixed bottom-0 left-0 right-0 glass border-t border-yellow-500/20 py-3 sm:py-4 z-50 shadow-xl"><div class="max-w-7xl mx-auto px-4 sm:px-6"><div class="flex items-center justify-center gap-2 sm:gap-3"><div class="w-8 h-8 sm:w-10 sm:h-10 gradient-gold rounded-full flex items-center justify-center pulse-slow shadow-lg shine"><i class="fas fa-users text-black text-sm sm:text-base"></i></div><p class="text-gray-700 font-medium text-xs sm:text-base">Tu negocio puede alcanzar <span class="text-yellow-600 font-bold text-sm sm:text-lg" id="view-counter">${state.viewCount.toLocaleString()}</span> <span class="text-gray-500">usuarios</span></p></div></div></div>`;
        const PasswordInput=(id,label,placeholder,required=false)=>`<div><label class="block text-sm font-semibold text-gray-700 mb-2 form-label-icon"><i class="fas fa-lock text-yellow-600"></i><span>${label}</span></label><div class="relative"><input type="${state.showPassword[id]?'text':'password'}" id="${id}" ${required?'required':''} placeholder="${placeholder}" class="w-full px-5 py-4 pr-12 rounded-xl border-2 border-gray-300 bg-white text-gray-900 focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus transition-all"><button type="button" onclick="togglePassword('${id}')" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-600 hover:text-yellow-600 transition-colors"><i class="fas fa-eye${state.showPassword[id]?'-slash':''}"></i></button></div></div>`;
        const LoginView=()=>{const isLogin=state.view==='login';return `<div class="min-h-screen flex items-center justify-center p-6"><div class="max-w-md w-full"><div class="glass p-10 shadow-2xl fade-in border-2 border-yellow-500/20"><div class="text-center mb-8">${isLogin?`<div class="w-34 h-34 sm:w-40 sm:h-40 rounded-3xl overflow-hidden mx-auto mb-4 shadow-2xl border-4 border-yellow-500 gradient-black-white-bg flex items-center justify-center shine"><img src="Logoubicanegoleongto.png" alt="Ubicanegoleon" class="w-full h-full object-contain p-0"></div>`:''}<h2 class="text-2xl sm:text-3xl font-extrabold gradient-gold-text-animated mb-4">${isLogin?'Ubicanegoleon':'Crear Cuenta'}</h2><p class="text-gray-500 text-sm">${isLogin?'Ingresa a tu cuenta':'Únete al directorio'}</p></div><form onsubmit="handleAuth(event)" class="space-y-5"><div><label class="block text-sm font-semibold text-gray-700 mb-2 form-label-icon"><i class="fas fa-envelope text-yellow-600"></i><span>Correo electrónico</span></label><input type="email" id="email" required placeholder="tu@correo.com" class="w-full px-5 py-4 rounded-xl border-2 border-gray-300 bg-white text-gray-900 focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus transition-all"></div>${PasswordInput('password','Contraseña','••••••••',true)}${!isLogin?PasswordInput('confirmPassword','Confirmar Contraseña','••••••••',true):''}${isLogin?`<div class="flex items-center justify-between"><label class="flex items-center gap-2 cursor-pointer group"><input type="checkbox" id="keepLoggedIn" ${state.keepLoggedIn?'checked':''} onchange="state.keepLoggedIn = this.checked" class="w-5 h-5 rounded border-gray-400 bg-white text-yellow-600 focus:ring-yellow-500"><span class="text-sm text-gray-600 group-hover:text-gray-900 transition-colors">Mantener sesión</span></label><button type="button" onclick="handleForgotPassword()" class="text-sm forgot-password-link">¿Olvidaste tu contraseña?</button></div>`:''}<button type="submit" class="w-full btn-gold text-black py-4 rounded-xl font-bold shadow-xl"><i class="fas fa-${isLogin?'sign-in-alt':'user-plus'} mr-2"></i>${isLogin?'Iniciar Sesión':'Registrarme'}</button>${isLogin?`<button type="button" onclick="changeView('list')" class="w-full py-4 gradient-green-intense text-white rounded-xl font-bold transition-all hover:scale-105 hover:shadow-xl"><i class="fas fa-eye mr-2"></i>Ver Directorio</button>`:''}<div class="text-center pt-4 border-t border-gray-300"><button type="button" onclick="changeView('${isLogin?'register':'login'}')" class="text-gray-600 hover:text-gray-900 transition-colors">${isLogin?'¿No tienes cuenta?':'¿Ya tienes cuenta?'} <span class="font-bold register-link ml-1">${isLogin?'Registrarse':'Inicia sesión'}</span></button></div></form></div><div class="mt-6 text-center text-sm text-gray-600"><p>Directorio oficial de negocios en León, Gto.</p><p class="text-xs text-gray-500 mt-1">By <span class="font-semibold text-yellow-600">axeltech</span></p></div></div></div>`;};
        const FormView=()=>{return `<div class="pb-24 sm:pb-28 min-h-screen">${Header()}<div class="max-w-4xl mx-auto mt-6 sm:mt-10 px-4 sm:px-6"><div class="glass p-6 sm:p-10 shadow-2xl fade-in border-2 border-yellow-500/20"><div class="mb-8"><h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2"><i class="fas fa-${state.currentBusiness?'edit':'plus-circle'} text-yellow-600 mr-3"></i>${state.currentBusiness?'Modificar':'Registrar'} Negocio</h2><p class="text-gray-600">* = Campos obligatorios</p></div><form onsubmit="handleBusinessSubmit(event)" class="space-y-6"><div class="glass-light p-6 border-2 border-dashed border-yellow-500/30"><label class="block text-sm font-bold text-gray-700 mb-3 form-label-icon"><i class="fas fa-image text-yellow-600"></i><span>Logotipo (Opcional)</span></label><div class="flex flex-col sm:flex-row items-center gap-6"><div class="w-full sm:w-40 h-40 image-upload-container border-2 border-dashed border-gray-400 overflow-hidden bg-gray-100 flex items-center justify-center cursor-pointer hover:border-yellow-500/50 transition-all" onclick="document.getElementById('logo-input').click()">${state.formData.logo_url?`<img src="${state.formData.logo_url}" class="image-preview-logo" alt="Preview">`:`<div class="text-center"><i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-2"></i><p class="text-xs text-gray-500">Click para subir</p></div>`}</div><input type="file" id="logo-input" accept="image/*" onchange="handleLogo(event)" class="hidden"><div class="flex-1 text-center sm:text-left"><p class="text-sm text-gray-600 mb-2">JPG, PNG (Máx. 10MB)</p></div></div></div><div class="space-y-6"><div><label class="block text-sm font-bold text-gray-700 mb-2 form-label-icon"><i class="fas fa-store text-yellow-600"></i><span>Nombre * (MAYÚSCULAS)</span></label><input type="text" id="name" required value="${state.formData.name}" placeholder="Ej: CAFÉ LA ESQUINA" oninput="forceUppercase(event); state.formData.name = this.value;" class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus uppercase-force"></div><div><label class="block text-sm font-bold text-gray-700 mb-2 form-label-icon"><i class="fas fa-user-tie text-yellow-600"></i><span>Representante</span></label><input type="text" id="representative" value="${state.formData.representative}" placeholder="Nombre del dueño" class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus"></div><div><label class="block text-sm font-bold text-gray-700 mb-2 form-label-icon"><i class="fas fa-tag text-yellow-600"></i><span>Giro</span></label><input type="text" id="category" value="${state.formData.category}" placeholder="Ej: Restaurante" class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-sm font-bold text-gray-700 mb-2 form-label-icon"><i class="fas fa-road text-yellow-600"></i><span>Calle y Número *</span></label><input type="text" id="street" required value="${state.formData.street}" placeholder="Ej: Blvd López Mateos 1234" class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus"></div><div><label class="block text-sm font-bold text-gray-700 mb-2 form-label-icon"><i class="fas fa-map-pin text-yellow-600"></i><span>Colonia *</span></label><input type="text" id="colony" required value="${state.formData.colony}" placeholder="Ej: Centro" class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus"></div></div><div><label class="block text-sm font-bold text-gray-700 mb-2 form-label-icon"><i class="fas fa-phone text-yellow-600"></i><span>Teléfono * (10 dígitos)</span></label><input type="tel" id="phone" required value="${state.formData.phone}" placeholder="4771234567" inputmode="numeric" pattern="[0-9]*" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10)" class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus"></div><div><label class="block text-sm font-bold text-gray-700 mb-2 form-label-icon"><i class="fas fa-calendar-alt text-yellow-600"></i><span>Días</span></label><select id="days" onchange="handleDaysChange(this.value)" class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none cursor-pointer"><option ${state.formData.days==='No definido'?'selected':''}>No definido</option><option ${state.formData.days==='Lunes a Viernes'?'selected':''}>Lunes a Viernes</option><option ${state.formData.days==='Solo fines de semana'?'selected':''}>Solo fines de semana</option><option ${state.formData.days==='Todos los días de la semana'?'selected':''}>Todos los días de la semana</option><option ${state.formData.days==='Otro'?'selected':''}>Otro</option></select></div>${state.showCustomDays?`<div class="fade-in"><label class="block text-sm font-bold text-gray-700 mb-2 form-label-icon"><i class="fas fa-edit text-yellow-600"></i><span>Especifica</span></label><textarea id="custom-days" rows="2" placeholder="Ej: Martes y Jueves..." class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus resize-none">${state.formData.custom_days}</textarea></div>`:''}<div><label class="flex items-center gap-3 mb-3 cursor-pointer"><input type="checkbox" id="enable-hours" ${state.enableHours?'checked':''} onchange="toggleHoursInput()" class="w-5 h-5 rounded border-gray-400 bg-white text-yellow-600 focus:ring-yellow-500"><span class="text-sm font-bold text-gray-700 form-label-icon"><i class="fas fa-clock text-yellow-600"></i><span>Especificar Horario</span></span></label><input type="text" id="hours" ${!state.enableHours?'disabled':''} value="${state.formData.hours}" placeholder="${state.enableHours?'Ej: 7:00 AM - 9:00 PM':'No definido'}" class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus ${!state.enableHours?'opacity-50 cursor-not-allowed':''}"></div><div><label class="block text-sm font-bold text-gray-700 mb-2 form-label-icon"><i class="fas fa-align-left text-yellow-600"></i><span>Descripción</span></label><textarea id="description" rows="4" placeholder="Cuéntanos..." class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus resize-none">${state.formData.description}</textarea></div><div><label class="block text-sm font-bold text-gray-700 mb-2 form-label-icon"><i class="fas fa-list-ul text-yellow-600"></i><span>Servicios</span></label><textarea id="services" rows="3" placeholder="Ej: Wifi, Estacionamiento..." class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus resize-none">${state.formData.services}</textarea></div></div><label class="flex items-start gap-4 p-5 bg-yellow-500/10 rounded-2xl cursor-pointer border-2 border-yellow-500/30 hover:border-yellow-500/50 transition-all group"><input type="checkbox" id="agreed" ${state.formData.agreed?'checked':''} class="w-6 h-6 mt-1 rounded-lg border-2 border-yellow-600 bg-white text-yellow-600 focus:ring-yellow-500"><div class="flex-1"><p class="font-semibold text-yellow-700 group-hover:text-yellow-800"><i class="fas fa-shield-check mr-2"></i>Confirmo que los datos son correctos</p></div></label><div class="flex flex-col sm:flex-row gap-4 pt-4"><button type="button" onclick="changeView('list')" class="flex-1 py-4 gradient-red text-white rounded-xl font-bold transition-all hover:scale-105 hover:shadow-xl"><i class="fas fa-times mr-2"></i>Cancelar</button><button type="submit" class="flex-1 gradient-green text-white py-4 rounded-xl font-bold shadow-lg hover:scale-105 hover:shadow-xl transition-all"><i class="fas fa-save mr-2"></i>Guardar</button></div></form></div></div>${Footer()}</div>`;};
        const ListView=()=>{const filtered=state.businesses.filter(b=>b.name.toLowerCase().includes(state.searchTerm.toLowerCase())||(b.category&&b.category.toLowerCase().includes(state.searchTerm.toLowerCase())));return `<div class="pb-20 sm:pb-28 min-h-screen">${Header()}<div class="glass border-b border-yellow-500/20 py-6 sm:py-8 px-4 sm:px-6 mb-6 sm:mb-10 shadow-xl"><div class="max-w-7xl mx-auto"><div class="text-center mb-6"><h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Descubre Negocios en León</h2><p class="text-gray-600">Encuentra los mejores establecimientos</p></div><div class="relative max-w-2xl mx-auto fade-in flex gap-3"><div class="relative flex-1"><i class="fas fa-search absolute left-4 sm:left-6 top-1/2 transform -translate-y-1/2 text-gray-500 text-lg sm:text-xl"></i><input type="text" id="search" value="${state.tempSearchTerm}" oninput="handleSearchInput(event)" placeholder="Busca por nombre o giro..." class="w-full pl-12 sm:pl-16 pr-4 sm:pr-6 py-4 sm:py-5 rounded-2xl bg-white border-2 border-gray-300 text-gray-900 placeholder-gray-500 focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus text-base sm:text-lg shadow-lg"></div><button onclick="performSearch()" class="gradient-navy-blue text-white px-6 sm:px-8 py-4 sm:py-5 rounded-2xl font-bold shadow-lg hover:scale-105 transition-all whitespace-nowrap"><i class="fas fa-search mr-2"></i><span class="hidden sm:inline">Buscar</span></button></div></div></div><main class="max-w-7xl mx-auto px-4 sm:px-6">${filtered.length===0?`<div class="text-center py-20 fade-in"><div class="w-32 h-32 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-6"><i class="fas fa-search text-6xl text-gray-400"></i></div><h3 class="text-2xl font-bold text-gray-900 mb-2">No se encontraron negocios</h3><p class="text-gray-600 mb-6">Intenta con otros términos</p>${state.user?`<button onclick="createBusiness()" class="btn-gold text-black px-8 py-4 rounded-xl font-bold shadow-xl hover:scale-105 transition-all"><i class="fas fa-plus mr-2"></i>Registra el primer negocio</button>`:''}</div>`:`<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8">${filtered.map((b,i)=>`<div class="glass overflow-hidden shadow-xl card-hover fade-in border border-yellow-500/10" style="animation-delay: ${i*0.1}s"><div class="h-48 sm:h-56 overflow-hidden relative bg-gradient-to-br from-gray-200 to-gray-300"><img src="${b.logo_url||'https://via.placeholder.com/400x300/f8f9fa/d4af37?text=Sin+Logo'}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/400x300/f8f9fa/d4af37?text=Negocio'"><div class="absolute top-4 right-4"><span class="px-3 sm:px-4 py-1.5 sm:py-2 category-badge-white-gold text-xs shadow-lg rounded-full">${b.category||'Negocio'}</span></div>${b.rating>0?`<div class="absolute bottom-4 left-4"><div class="rating-badge flex items-center gap-2 px-3 py-2 shadow-lg"><i class="fas fa-star text-yellow-400"></i><span class="font-bold text-white">${b.rating}</span><span class="text-xs text-white/80">(${b.total_ratings})</span></div></div>`:''}</div><div class="p-5 sm:p-6 business-card-footer"><h3 class="business-card-name text-lg sm:text-xl mb-3 line-clamp-1">${b.name}</h3><div class="space-y-2 mb-5">${b.address?`<p class="text-sm text-black flex items-start gap-2 card-text-bold"><i class="fas fa-map-marker-alt icon-location mt-1 flex-shrink-0"></i><span class="line-clamp-2">${b.address}</span></p>`:''}${b.phone?`<p class="text-sm text-black flex items-center gap-2 card-text-bold"><i class="fas fa-phone icon-phone"></i><span>${b.phone}</span></p>`:''}</div><div class="flex gap-3"><button onclick="viewBusiness('${b.id}')" class="flex-1 py-3 gradient-blue-strong text-white font-bold rounded-xl hover:shadow-xl transition-all hover:scale-105">Ver Detalles</button>${state.user&&b.user_id===state.user.id?`<button onclick="editBusiness('${b.id}')" class="p-3 gradient-green-translucent text-white rounded-xl transition-all hover:scale-105"><i class="fas fa-edit"></i></button>`:''}</div></div></div>`).join('')}</div>`}</main>${Footer()}</div>`;};
        const ProfileView=()=>{const b=state.currentBusiness;if(!b)return '';setTimeout(()=>initMap(b.latitude||21.1212,b.longitude||-101.6869,b.name,b.address),500);const displayDays=b.days==='Otro'&&b.custom_days?b.custom_days:b.days;const daysClass=(b.days==='No definido'||!b.days)?'text-red-strong':'text-gray-900';const hoursClass=(b.hours==='No definido'||!b.hours)?'text-red-strong':'text-gray-900';return `<div class="pb-20 sm:pb-28 min-h-screen">${Header()}<div class="max-w-5xl mx-auto mt-6 sm:mt-10 px-4 sm:px-6"><div class="glass overflow-hidden shadow-2xl fade-in border-2 border-yellow-500/20"><div class="profile-header-container relative overflow-hidden px-4 sm:px-8 pt-4 sm:pt-6 pb-4 sm:pb-6 shine"><div class="absolute inset-0 bg-black/5"></div><button onclick="state.view='list'; render();" class="back-button absolute top-6 left-6 w-12 h-12 flex items-center justify-center text-white hover:bg-white/40 transition-all shadow-lg z-10"><i class="fas fa-arrow-left text-xl"></i></button><div class="relative z-10 mt-8"><div class="flex flex-col md:flex-row items-center md:items-start gap-3 mb-3"><div class="p-2 glass shadow-2xl flex-shrink-0"><img src="${b.logo_url||'https://via.placeholder.com/200/d4af37/000000?text=Logo'}" class="w-32 h-32 sm:w-40 sm:h-40 rounded-2xl object-cover" onerror="this.src='https://via.placeholder.com/200/d4af37/000000?text=Logo'"></div><div class="flex-1 text-center md:text-left mt-1"><h2 class="text-2xl sm:text-3xl font-bold business-name-white mb-2 drop-shadow-sm">${b.name}</h2>${b.category?`<span class="inline-block px-4 py-2 category-badge-white-gold rounded-full text-sm shadow-lg"><i class="fas fa-tag mr-2"></i>${b.category}</span>`:''}</div></div></div>${state.user&&b.user_id===state.user.id?`<div class="absolute top-6 right-6 z-10"><button onclick="deleteBusiness('${b.id}')" class="px-4 sm:px-6 py-3 sm:py-4 gradient-red text-white rounded-2xl font-bold transition-all shadow-lg hover:scale-105"><i class="fas fa-trash mr-2"></i><span class="hidden sm:inline">Eliminar</span></button></div>`:''}</div>${b.rating>0?`<div class="px-4 sm:px-8 py-5"><div class="max-w-3xl mx-auto"><div class="rating-container-profile flex items-center justify-center gap-4"><i class="fas fa-star text-yellow-400 text-3xl"></i><div><p class="text-4xl font-bold text-white">${b.rating}</p><p class="text-sm text-white/90">${b.total_ratings} ${b.total_ratings===1?'reseña':'reseñas'}</p></div></div></div></div>`:''}<div class="px-4 sm:px-8 py-6 sm:py-8">${b.description?`<div class="mb-6"><div class="section-card-gold-border p-6 sm:p-8 shadow-lg gradient-yellow-white-soft"><h4 class="text-sm title-gold-dark uppercase tracking-wider mb-3 form-label-icon"><i class="fas fa-info-circle"></i><span>Descripción</span></h4><p class="text-gray-900 font-bold leading-relaxed text-base sm:text-lg">${b.description}</p></div></div>`:''}${b.services?`<div class="mb-6"><div class="section-card-gold-border p-6 sm:p-8 shadow-lg gradient-yellow-white-soft"><h4 class="text-sm title-gold-dark uppercase tracking-wider mb-3 form-label-icon"><i class="fas fa-list-ul"></i><span>Servicios</span></h4><p class="text-gray-900 font-bold leading-relaxed text-base sm:text-lg">${b.services}</p></div></div>`:''}<div class="info-container-white mb-8"><div class="space-y-5"><section><h4 class="text-sm title-gold-dark uppercase tracking-wider mb-4 form-label-icon"><i class="fas fa-info-circle"></i><span>Contacto</span></h4><div class="space-y-3">${b.phone?`<div class="section-card-gold-border flex items-center gap-4 p-4"><div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center flex-shrink-0"><i class="fas fa-phone icon-phone text-xl"></i></div><div class="flex-1 min-w-0"><p class="text-xs text-gray-500 mb-1">Teléfono</p><p class="font-semibold text-gray-900 break-all">${b.phone}</p></div></div>`:''}${b.address?`<div class="section-card-gold-border flex items-start gap-4 p-4"><div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center flex-shrink-0"><i class="fas fa-map-marked-alt text-red-500 text-xl"></i></div><div class="flex-1 min-w-0"><p class="text-xs text-gray-500 mb-1">Dirección</p><p class="font-semibold text-gray-900 break-words">${b.address}, León, Gto.</p></div></div>`:''}</div></section>${b.representative?`<section><h4 class="text-sm title-gold-dark uppercase tracking-wider mb-4 form-label-icon"><i class="fas fa-user-tie"></i><span>Representante</span></h4><div class="section-card-gold-border p-6"><p class="font-semibold text-gray-900 break-words">${b.representative}</p></div></section>`:''}<section><h4 class="text-sm title-gold-dark uppercase tracking-wider mb-4 form-label-icon"><i class="fas fa-clock"></i><span>Horario</span></h4><div class="section-card-gold-border p-6 space-y-3"><div class="flex items-center justify-between py-2 border-b border-gray-300"><span class="text-gray-600 font-medium">Días</span><span class="font-bold ${daysClass} text-right break-words ml-4">${displayDays}</span></div><div class="flex items-center justify-between py-2"><span class="text-gray-600 font-medium">Horario</span><span class="font-bold ${hoursClass} text-right break-words ml-4">${b.hours||'No definido'}</span></div></div></section><section><h4 class="text-sm title-gold-dark uppercase tracking-wider mb-4 form-label-icon"><i class="fas fa-map-marked-alt"></i><span>Mapa</span></h4><div class="section-card-gold-border overflow-hidden"><div id="business-map" class="map-container"></div></div>${b.phone?`<button onclick="openWhatsApp('${b.phone}','${b.name.replace(/'/g,"\\'")}' )" class="w-full mt-4 whatsapp-button text-white py-4 rounded-xl font-bold shadow-lg transition-all flex items-center justify-center gap-3 hover:scale-105"><i class="fab fa-whatsapp text-2xl"></i><span>Contactar por WhatsApp</span></button>`:''}</section></div></div>${state.user?`<div class="glass-light p-6 sm:p-8 border-2 border-yellow-500/20 mb-8"><h4 class="text-xl sm:text-2xl font-bold text-gray-900 mb-6"><i class="fas fa-star text-yellow-600 mr-2"></i>Deja tu opinión</h4><form onsubmit="handleReview(event, '${b.id}')" class="space-y-6"><div><label class="block text-sm font-bold text-gray-700 mb-3">Calificación *</label><div class="flex gap-2 sm:gap-3 justify-center">${[1,2,3,4,5].map(i=>`<button type="button" onclick="event.preventDefault(); selectRating(${i})" class="star-btn text-4xl sm:text-5xl transition-all hover:scale-125" data-rating="${i}"><span class="${state.selectedRating>=i?'text-yellow-500':'text-gray-400'}">★</span></button>`).join('')}</div></div><div><label class="block text-sm font-bold text-gray-700 mb-3">Comentario (opcional)</label><textarea id="review-comment" rows="4" placeholder="Comparte..." class="w-full px-4 py-3 border-2 border-gray-300 bg-white text-gray-900 rounded-xl focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus resize-none"></textarea></div><div class="flex justify-center"><button type="submit" class="gradient-green text-white px-8 py-4 rounded-xl font-bold shadow-lg hover:scale-105 transition-all"><i class="fas fa-paper-plane mr-2"></i>Publicar</button></div></form></div>`:`<div class="glass-light p-8 text-center mb-8 border-2 border-gray-300"><i class="fas fa-lock text-4xl text-gray-400 mb-4"></i><p class="text-gray-600 mb-4">Inicia sesión</p><button onclick="changeView('login')" class="btn-gold text-black px-8 py-3 rounded-xl font-bold shadow-xl hover:scale-105 transition-all">Iniciar Sesión</button></div>`}<div class="border-t-2 border-gray-300 pt-8"><h4 class="text-xl sm:text-2xl font-bold text-gray-900 mb-6"><i class="fas fa-comments text-yellow-600 mr-2"></i>Reseñas (${b.reviews?.length||0})</h4>${(b.reviews&&b.reviews.length>0)?`<div class="space-y-4">${b.reviews.map(r=>`<div class="glass-light p-4 sm:p-6 hover:shadow-xl transition-all"><div class="flex items-start justify-between mb-3"><div class="flex items-center gap-3"><div class="w-10 h-10 sm:w-12 sm:h-12 gradient-gold rounded-full flex items-center justify-center text-black font-bold text-base sm:text-lg flex-shrink-0">${r.user_name.charAt(0).toUpperCase()}</div><div><p class="font-bold text-gray-900 break-words">${r.user_name}</p><p class="text-xs text-gray-500">${new Date(r.created_at).toLocaleDateString('es-MX')}</p></div></div><div class="flex gap-1 text-yellow-500 text-lg sm:text-xl flex-shrink-0 ml-2">${'★'.repeat(r.rating)}${'☆'.repeat(5-r.rating)}</div></div>${r.comment?`<p class="text-gray-700 leading-relaxed break-words">${r.comment}</p>`:''}</div>`).join('')}</div>`:`<div class="text-center py-12 glass-light"><i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i><p class="text-gray-600">Aún no hay reseñas</p></div>`}</div></div></div></div>${Footer()}</div>`;};
        async function handleAuth(e){e.preventDefault();const email=document.getElementById('email').value.trim();const password=document.getElementById('password').value;if(state.view==='login'){const result=await loginUser(email,password);if(result.success){if(state.keepLoggedIn)localStorage.setItem('keepLoggedIn','true');await loadBusinesses();state.view='list';render();}else{const err=getAuthErrorMessage(result.error);showModal(err.title,err.message,err.type);}}else{const confirmPassword=document.getElementById('confirmPassword').value;if(password!==confirmPassword){showModal('Error','Las contraseñas no coinciden.','error');return;}const result=await registerUser(email,password,confirmPassword);if(result.success){const msg=result.requiresConfirmation?'Cuenta creada. Revisa tu correo.':'Cuenta creada.';showModal('¡Éxito!',msg,'success');setTimeout(()=>{state.view='login';render();},2000);}else{const err=getAuthErrorMessage(result.error);showModal(err.title,err.message,err.type);}}}
        function handleForgotPassword(){const modal=document.createElement('div');modal.className='modal-overlay fixed inset-0 z-50 flex items-center justify-center p-6';modal.innerHTML=`<div class="modal-content glass max-w-md w-full overflow-hidden shadow-2xl border-2 border-blue-500/30"><div class="bg-blue-500/10 p-6 border-b border-gray-300/50"><div class="flex items-center gap-4"><div class="w-16 h-16 rounded-full bg-white/50 flex items-center justify-center shadow-lg"><i class="fas fa-key text-4xl text-blue-500"></i></div><h3 class="text-2xl font-bold text-gray-900">Recuperar</h3></div></div><form id="forgot-password-form" class="p-6 space-y-5"><p class="text-gray-600 mb-4 text-base">Ingresa tu correo.</p><div><label class="block text-sm font-semibold text-gray-700 mb-2 form-label-icon"><i class="fas fa-envelope text-yellow-600"></i><span>Correo</span></label><input type="email" id="reset-email" required placeholder="tu@correo.com" class="w-full px-5 py-4 rounded-xl border-2 border-gray-300 bg-white text-gray-900 focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/20 outline-none input-focus transition-all"></div><div class="flex gap-3 pt-4"><button type="button" onclick="this.closest('.modal-overlay').remove()" class="flex-1 px-6 py-4 gradient-red text-white rounded-xl font-semibold transition-all hover:scale-105 hover:shadow-lg">Cancelar</button><button type="submit" class="flex-1 px-6 py-4 gradient-green text-white rounded-xl font-semibold transition-all hover:scale-105 hover:shadow-lg"><i class="fas fa-paper-plane mr-2"></i>Enviar</button></div></form></div>`;document.getElementById('modal-root').appendChild(modal);document.getElementById('forgot-password-form').addEventListener('submit',async(e)=>{e.preventDefault();const email=document.getElementById('reset-email').value.trim();const result=await resetPassword(email);modal.remove();if(result.success){showModal('Correo Enviado 📧','Revisa tu bandeja.','success');}else{const err=getAuthErrorMessage(result.error);showModal(err.title,err.message,err.type);}});}
        function handleLogo(e){const file=e.target.files[0];if(!file)return;if(file.size>10*1024*1024){showModal('Archivo Grande','Máx. 10MB','error');e.target.value='';return;}state.formData.logo=file;const reader=new FileReader();reader.onload=(event)=>{state.formData.logo_url=event.target.result;render();};reader.readAsDataURL(file);}
        async function handleBusinessSubmit(e){e.preventDefault();const phoneInput=document.getElementById('phone').value.trim();const phoneDigits=phoneInput.replace(/\D/g,'');state.formData.name=document.getElementById('name').value.trim().toUpperCase();state.formData.representative=document.getElementById('representative').value.trim();state.formData.category=document.getElementById('category').value.trim();state.formData.street=document.getElementById('street').value.trim();state.formData.colony=document.getElementById('colony').value.trim();state.formData.phone=phoneDigits;state.formData.hours=document.getElementById('hours')?.value.trim()||'No definido';state.formData.days=document.getElementById('days').value;state.formData.custom_days=state.showCustomDays?(document.getElementById('custom-days')?.value.trim()||''):'';state.formData.description=document.getElementById('description').value.trim();state.formData.services=document.getElementById('services').value.trim();state.formData.agreed=document.getElementById('agreed').checked;await saveBusiness(state.formData);}
        async function handleReview(e,businessId){e.preventDefault();if(!state.selectedRating||state.selectedRating===0){showModal('Calificación Requerida','Selecciona 1-5 estrellas.','warning');return;}const comment=document.getElementById('review-comment')?.value.trim()||'';await saveReview(businessId,state.selectedRating,comment);}
        function handleSearchInput(e){state.tempSearchTerm=e.target.value;}
        function performSearch(){const input=document.getElementById('search');if(input){state.searchTerm=input.value;state.tempSearchTerm=input.value;render();}}
        function selectRating(rating){state.selectedRating=rating;render();}
        function changeView(view){state.view=view;if(view==='list'){state.searchTerm='';state.tempSearchTerm='';}render();}
        function createBusiness(){if(!state.user){showModal('Sesión Requerida','Inicia sesión primero','warning');changeView('login');return;}resetForm();state.currentBusiness=null;state.view='form';render();}
        function editBusiness(id){const business=state.businesses.find(b=>b.id===id);if(!business)return;const parts=business.address.split(',').map(s=>s.trim());const street=parts.length>1?parts[0]:'';const colony=parts.length>1?parts[1]:'';state.currentBusiness=business;state.formData={name:business.name||'',representative:business.representative||'',category:business.category||'',street:street,colony:colony,phone:business.phone||'',hours:business.hours||'No definido',days:business.days||'No definido',custom_days:business.custom_days||'',description:business.description||'',services:business.services||'',logo:null,logo_url:business.logo_url||'',agreed:false,latitude:business.latitude||21.1212,longitude:business.longitude||-101.6869};state.enableHours=business.hours&&business.hours!=='No definido';state.showCustomDays=business.days==='Otro';state.view='form';render();}
        function viewBusiness(id){const business=state.businesses.find(b=>b.id===id);if(!business)return;state.currentBusiness=business;state.view='profile';state.selectedRating=0;render();}
        function render(){const views={login:LoginView,register:LoginView,form:FormView,list:ListView,profile:ProfileView};document.getElementById('app').innerHTML=(views[state.view]||LoginView)();window.scrollTo({top:0,behavior:'smooth'});}
        (async function init(){try{const hashParams=new URLSearchParams(window.location.hash.substring(1));const type=hashParams.get('type');if(type==='recovery'){state.isPasswordReset=true;showPasswordResetModal();return;}const{data,error}=await supabaseClient.auth.getSession();if(data.session){state.user=data.session.user;state.view='list';if(localStorage.getItem('keepLoggedIn'))state.keepLoggedIn=true;}await loadBusinesses();render();supabaseClient.auth.onAuthStateChange(async(event,session)=>{const currentHash=window.location.hash;const isRecoveryUrl=currentHash.includes('type=recovery');if(event==='PASSWORD_RECOVERY'||(event==='SIGNED_IN'&&isRecoveryUrl)){state.isPasswordReset=true;state.user=session?.user||null;showPasswordResetModal();}else if(event==='SIGNED_IN'&&!state.isPasswordReset){state.user=session?.user||null;state.view='list';await loadBusinesses();render();}else if(event==='SIGNED_OUT'){state.user=null;state.view='login';window.history.replaceState(null,'',window.location.pathname);render();}});}catch(error){showModal('Error','Error al cargar.','error');}})();
    </script>
</body>
</html>
